<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browser-Style Sidebar Tab System</title>
  <script src="/scram/scramjet.controller.js"></script>
  <script src="/baremux/index.js"></script>
  <script src="/uv/uv.bundle.js"></script>
  <script src="/uv/uv.config.js"></script>
  <link rel="prefetch" href="/scram/scramjet.worker.js" />
  <link rel="prefetch" href="/scram/scramjet.shared.js" />
  <style>
    body, html {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      background-color: #132337;
      color: white;
      overflow: hidden;
    }

    .browser {
      display: flex;
      height: 100vh;
    }

    /* Sidebar tabs styling */
    .sidebar {
      width: 200px;
      background-color: #0c1a29;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #254b6e;
    }

    .tabs-container {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      overflow-y: auto;
      padding-top: 10px;
      scrollbar-width: none;
    }

    .tabs-container::-webkit-scrollbar {
      display: none;
    }

    .tab {
      position: relative;
      width: 180px;
      height: 36px;
      border-radius: 18px;
      background-color: #16324A;
      margin: 0 auto 10px;
      padding: 0 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background-color 0.2s;
    }

    .tab.active {
      background-color: #254b6e;
    }

    .tab.dragging {
      opacity: 0.5;
    }

    .tab.drag-over {
      border: 2px dashed #fff;
    }

    .tab.drop-above {
      border-top: 2px solid #fff;
    }

    .tab.drop-below {
      border-bottom: 2px solid #fff;
    }

    .tab-favicon {
      width: 16px;
      height: 16px;
      object-fit: contain;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .tab-title-display {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 12px;
      max-width: 120px;
    }

    .tab-tooltip {
      position: absolute;
      left: 50px;
      background-color: #254b6e;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s;
      z-index: 100;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tab:hover .tab-tooltip {
      opacity: 1;
      visibility: visible;
    }

    .tab-close {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 16px;
      height: 16px;
      background-color: #0c1a29;
      border: 1px solid #254b6e;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      opacity: 0;
      transition: visibility 0s, opacity 0.2s;
      cursor: pointer;
      padding: 0;
      z-index: 10;
    }

    .tab:hover .tab-close {
      visibility: visible;
      opacity: 1;
    }

    .tab-close svg {
      width: 10px;
      height: 10px;
    }

    .new-tab-button {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: #16324A;
      border: 1px solid #254b6e;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px auto;
    }

    .new-tab-button:hover {
      background-color: #254b6e;
    }

    /* Main content area styling */
    .main-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .navigation-bar {
      background-color: #0c1a29;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-buttons {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .nav-button {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      border-radius: 50%;
    }

    .nav-button:hover {
      background-color: #254b6e;
    }

    #url-bar {
      flex-grow: 1;
      background-color: #1d324d;
      border: none;
      border-radius: 20px;
      color: white;
      padding: 8px 15px;
      font-size: 14px;
      outline: none;
    }

    .search-button {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }

    .browser-container {
      flex-grow: 1;
      position: relative;
      background-color: white;
    }

    .iframe-wrapper {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      transition: opacity 0.3s;
    }

    .iframe-wrapper.active {
      display: block;
    }
    
    .browser-frame {
      width: 100%;
      height: 100%;
      border: none;
    }

    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      color: #254b6e;
    }

    .browser-container {
      position: relative;
      flex-grow: 1;
    }

    .browser-container.loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(19, 35, 55, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .browser-container.loading::before {
      content: 'Loading...';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 18px;
      z-index: 11;
    }
  </style>
</head>
<body>
  <div class="browser">
    <div class="sidebar">
      <button class="new-tab-button" title="Add new tab">+</button>
      <div class="tabs-container">
        <!-- Tabs will be added here -->
      </div>
    </div>
    <div class="main-content">
      <div class="navigation-bar">
        <div class="nav-buttons">
          <button class="nav-button" id="back-button" title="Back">‚Üê</button>
          <button class="nav-button" id="forward-button" title="Forward">‚Üí</button>
          <button class="nav-button" id="reload-button" title="Reload">‚ü≥</button>
        </div>
        <input type="text" id="url-bar" placeholder="Search without being tracked">
        <button class="search-button" id="search-button" title="Search">üîç</button>
      </div>
      <div class="browser-container">
        <!-- iFrames will be added here directly -->
      </div>
    </div>
  </div>

  <script>
    // Dummy functions for compatibility with the provided code
    function uvEncode(url) {
      // This would be replaced with your actual UV encoding function
      return '/uv/service/' + encodeURIComponent(url);
    }

    function sjEncode(url) {
      // This would be replaced with your actual Scramjet encoding function
      return '/scram/service/' + encodeURIComponent(url);
    }

    function uvDecodeUrl(url) {
      // This would be replaced with your actual UV decoding function
      return decodeURIComponent(url);
    }

    function sjDecodeUrl(url) {
      // This would be replaced with your actual Scramjet decoding function
      return decodeURIComponent(url);
    }

    // Mock __uv$config for testing purposes
    const __uv$config = {
      prefix: '/uv/service/',
      encodeUrl: (url) => encodeURIComponent(url)
    };

    // Mock scramjet for testing purposes
    const scramjet = {
      encodeUrl: (url) => '/scram/service/' + encodeURIComponent(url)
    };

    // Set default search engine if not present
    if (!localStorage.getItem('searchEngine')) {
      localStorage.setItem('searchEngine', 'duckduckgo');
    }

    // Set default proxy if not present
    if (!localStorage.getItem('proxy')) {
      localStorage.setItem('proxy', 'uv');
    }

    class Tab {
      constructor(url = 'https://' + localStorage.getItem('searchEngine') + '.com/') {
        this.id = Math.random().toString(36).substr(2, 9);
        this.originalUrl = url;
        if (localStorage.getItem("proxy") == "uv") {
          this.url = uvEncode(url);
        }
        else {
          this.url = sjEncode(url);
        }
        this.title = 'New Tab';
        this.favicon = '/assets/imgs/logos/boltbrowser.svg';
        this.element = this.createTabElement();
        this.iframe = this.createIframe();
      }

      createTabElement() {
        const tab = document.createElement('div');
        tab.className = 'tab';
        tab.setAttribute('data-tab-id', this.id);
        tab.innerHTML = `
          <img class="tab-favicon" src="${this.favicon}" alt="">
          <span class="tab-title-display">${this.title}</span>
          <span class="tab-tooltip">${this.title}</span>
          <button class="tab-close">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        `;
        return tab;
      }

      createIframe() {
        // Create wrapper container for the iframe
        const wrapper = document.createElement('div');
        wrapper.id = `wrapper-${this.id}`;
        wrapper.className = 'iframe-wrapper';
        
        const iframe = document.createElement('iframe');
        iframe.id = `frame-${this.id}`;
        iframe.className = 'browser-frame';
        iframe.src = this.url;
        
        // Add iframe to the wrapper
        wrapper.appendChild(iframe);

        // Add the wrapper directly to the browser container
        document.querySelector('.browser-container').appendChild(wrapper);

        iframe.addEventListener('load', () => {
          try {
            const title = iframe.contentWindow.document.title;
            try {
              // This might fail due to cross-origin restrictions
              this.originalUrl = iframe.contentWindow.location.href;
              // Update URL bar with current URL
              if (this.id === tabManager.activeTabId) {
                document.getElementById('url-bar').value = this.originalUrl;
              }
            } catch (e) {
              console.log("Could not access iframe location due to CORS");
            }

            let favicon = '/assets/imgs/logos/boltbrowser.svg';

            const faviconEl = iframe.contentWindow.document.querySelector('link[rel="icon"], link[rel="shortcut icon"], link[rel="apple-touch-icon"]');
            if (faviconEl && faviconEl.href) {
              favicon = faviconEl.href;
            } else {
              const url = new URL(this.originalUrl);
              favicon = `${url.protocol}//${url.hostname}/favicon.ico`;
            }

            this.update(title, favicon);
          } catch (err) {
            console.error("Error updating tab info:", err);
            this.update('New Tab', '/assets/imgs/logos/boltbrowser.svg');
          }
          document.querySelector('.browser-container').classList.remove('loading');
        });

        return iframe;
      }

      show() {
        if (this.iframe && this.iframe.parentElement) {
          // Add active class to iframe wrapper
          this.iframe.parentElement.classList.add('active');
        }
      }

      hide() {
        if (this.iframe && this.iframe.parentElement) {
          // Remove active class from iframe wrapper
          this.iframe.parentElement.classList.remove('active');
        }
      }

      remove() {
        this.element.remove();
        if (this.iframe && this.iframe.parentElement) {
          this.iframe.parentElement.remove();
        }
      }

      update(title, favicon) {
        this.title = title || 'New Tab';
        this.favicon = favicon || '/assets/imgs/logos/boltbrowser.svg';
        
        // Update both the visible title and tooltip
        const titleDisplayEl = this.element.querySelector('.tab-title-display');
        const tooltipEl = this.element.querySelector('.tab-tooltip');
        
        titleDisplayEl.textContent = this.title;
        tooltipEl.textContent = this.title;
        
        const faviconEl = this.element.querySelector('.tab-favicon');
        faviconEl.src = this.favicon;
      }
    }

    class TabManager {
      constructor() {
        this.tabs = new Map();
        this.activeTabId = null;
        this.tabsContainer = document.querySelector('.tabs-container');
        this.browserContainer = document.querySelector('.browser-container');
        this.draggedTab = null;
        this.draggedTabIndex = null;

        document.querySelector('.new-tab-button').addEventListener('click', () => this.createTab());

        // Initialize drag and drop functionality
        this.initDragAndDrop();

        // Setup navigation controls
        document.getElementById('url-bar').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            this.navigateToUrl(e.target.value);
          }
        });

        document.getElementById('search-button').addEventListener('click', () => {
          this.navigateToUrl(document.getElementById('url-bar').value);
        });

        document.getElementById('back-button').addEventListener('click', () => {
          if (this.activeTabId) {
            const tab = this.tabs.get(this.activeTabId);
            if (tab && tab.iframe.contentWindow) {
              try {
                tab.iframe.contentWindow.history.back();
              } catch (e) {
                console.error("Could not go back:", e);
              }
            }
          }
        });

        document.getElementById('forward-button').addEventListener('click', () => {
          if (this.activeTabId) {
            const tab = this.tabs.get(this.activeTabId);
            if (tab && tab.iframe.contentWindow) {
              try {
                tab.iframe.contentWindow.history.forward();
              } catch (e) {
                console.error("Could not go forward:", e);
              }
            }
          }
        });

        document.getElementById('reload-button').addEventListener('click', () => {
          if (this.activeTabId) {
            const tab = this.tabs.get(this.activeTabId);
            if (tab && tab.iframe) {
              document.querySelector('.browser-container').classList.add('loading');
              tab.iframe.src = tab.url;
            }
          }
        });
      }

      initDragAndDrop() {
        this.tabsContainer.addEventListener('dragstart', this.handleDragStart.bind(this));
        this.tabsContainer.addEventListener('dragover', this.handleDragOver.bind(this));
        this.tabsContainer.addEventListener('dragenter', this.handleDragEnter.bind(this));
        this.tabsContainer.addEventListener('dragleave', this.handleDragLeave.bind(this));
        this.tabsContainer.addEventListener('drop', this.handleDrop.bind(this));
        this.tabsContainer.addEventListener('dragend', this.handleDragEnd.bind(this));
      }

      handleDragStart(e) {
        const tabElement = e.target.closest('.tab');
        if (!tabElement) return;

        if (e.target.closest('.tab-close')) {
          e.preventDefault();
          return;
        }

        this.draggedTab = tabElement;
        this.draggedTabIndex = Array.from(this.tabsContainer.children).indexOf(tabElement);

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', tabElement.getAttribute('data-tab-id'));

        setTimeout(() => {
          tabElement.classList.add('dragging');
        }, 0);
      }

      handleDragOver(e) {
        if (!this.draggedTab) return;
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';

        const targetTab = e.target.closest('.tab');
        if (!targetTab || targetTab === this.draggedTab) return;

        const targetRect = targetTab.getBoundingClientRect();
        const midpoint = targetRect.top + (targetRect.height / 2);

        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('drop-above', 'drop-below');
        });

        if (e.clientY < midpoint) {
          targetTab.classList.add('drop-above');
        } else {
          targetTab.classList.add('drop-below');
        }
      }

      handleDragEnter(e) {
        const targetTab = e.target.closest('.tab');
        if (targetTab && targetTab !== this.draggedTab) {
          targetTab.classList.add('drag-over');
        }
      }

      handleDragLeave(e) {
        const targetTab = e.target.closest('.tab');
        if (targetTab) {
          targetTab.classList.remove('drag-over');
        }
      }

      handleDrop(e) {
        e.preventDefault();
        if (!this.draggedTab) return;

        const targetTab = e.target.closest('.tab');
        if (!targetTab || targetTab === this.draggedTab) {
          this.resetDragState();
          return;
        }

        const targetRect = targetTab.getBoundingClientRect();
        const midpoint = targetRect.top + (targetRect.height / 2);

        if (e.clientY < midpoint) {
          this.tabsContainer.insertBefore(this.draggedTab, targetTab);
        } else {
          this.tabsContainer.insertBefore(this.draggedTab, targetTab.nextSibling);
        }

        this.resetDragState();
      }

      handleDragEnd() {
        this.resetDragState();
      }

      resetDragState() {
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('dragging', 'drag-over', 'drop-above', 'drop-below');
        });

        this.draggedTab = null;
        this.draggedTabIndex = null;
      }

      createTab(url) {
        const tab = new Tab(url);
        this.tabs.set(tab.id, tab);
        this.tabsContainer.appendChild(tab.element);

        tab.element.setAttribute('draggable', 'true');

        tab.element.addEventListener('click', (e) => {
          if (!e.target.closest('.tab-close')) {
            this.activateTab(tab.id);
          }
        });

        tab.element.querySelector('.tab-close').addEventListener('click', (e) => {
          e.stopPropagation();
          this.closeTab(tab.id);
        });

        document.querySelector('.browser-container').classList.add('loading');
        this.activateTab(tab.id);
        return tab;
      }

      activateTab(tabId) {
        const newTab = this.tabs.get(tabId);
        if (!newTab) {
          console.error(`Tab with ID ${tabId} not found`);
          return;
        }

        if (this.activeTabId) {
          const oldTab = this.tabs.get(this.activeTabId);
          if (oldTab) {
            oldTab.element.classList.remove('active');
            oldTab.hide();
          }
        }

        this.activeTabId = tabId;
        newTab.element.classList.add('active');
        newTab.show();

        var setUrl = newTab.originalUrl;
        setUrl = setUrl.replace(window.location.origin, '');
        if (setUrl.includes('uv')) {
          setUrl = setUrl.replace('/uv/service/', '');
          setUrl = uvDecodeUrl(setUrl);
        }
        if (setUrl.includes('scram')) {
          setUrl = setUrl.replace('/scram/service/', '');
          setUrl = sjDecodeUrl(setUrl);
        }
        document.getElementById('url-bar').value = setUrl;
      }

      closeTab(tabId) {
        const tab = this.tabs.get(tabId);
        if (!tab) return;

        const tabsArray = Array.from(this.tabs.keys());
        const closingTabIndex = tabsArray.indexOf(tabId);

        tab.remove();
        this.tabs.delete(tabId);

        if (this.activeTabId === tabId) {
          const remainingTabs = Array.from(this.tabs.keys());
          if (remainingTabs.length) {
            const newActiveIndex = Math.max(0, closingTabIndex - 1);
            const newTabId = remainingTabs[newActiveIndex];

            if (this.tabs.has(newTabId)) {
              this.activateTab(newTabId);
            } else if (remainingTabs.length > 0) {
              this.activateTab(remainingTabs[0]);
            } else {
              this.createTab();
            }
          } else {
            this.createTab();
          }
        }
      }

      navigateToUrl(url) {
        if (!url.trim()) return;
      
        // Add http:// prefix if needed
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          url = 'https://' + url;
        }

        if (this.activeTabId) {
          document.querySelector('.browser-container').classList.add('loading');
          const tab = this.tabs.get(this.activeTabId);
          tab.originalUrl = url;
          if (localStorage.getItem("proxy") == "uv") {
            tab.url = uvEncode(url);
          }
          else {
            tab.url = sjEncode(url);
          }
          tab.iframe.src = tab.url;
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      window.tabManager = new TabManager();
      tabManager.createTab('https://' + localStorage.getItem('searchEngine') + '.com/');
    });
  </script>
</body>
</html>